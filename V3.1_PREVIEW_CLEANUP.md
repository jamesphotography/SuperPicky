# SuperPicky V3.1 é¢„è§ˆåŠŸèƒ½æ¸…ç†æ€»ç»“

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-10-19

## ğŸ¯ æ¸…ç†ç›®æ ‡

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œä»SuperPicky V3.1ä¸­å®Œå…¨ç§»é™¤é¢„è§ˆåŠŸèƒ½ï¼Œç®€åŒ–ä»£ç ç»“æ„ï¼Œä¸“æ³¨äºæ ¸å¿ƒå›¾åƒå¤„ç†åŠŸèƒ½ã€‚

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. ai_model.py ç®€åŒ–

**æ–‡ä»¶ä½ç½®**: `ai_model.py:71`

**ä¿®æ”¹å†…å®¹**:
- ç®€åŒ– `detect_and_draw_birds` å‡½æ•°ç­¾å
- ç§»é™¤ä¸å¿…è¦çš„å‚æ•°ï¼š`preview_callback`, `crop_temp_dir`, `center_threshold`

**ä¿®æ”¹å‰**:
```python
def detect_and_draw_birds(image_path, model, output_path, dir, ui_settings,
                          crop_temp_dir=None, center_threshold=None, preview_callback=None):
```

**ä¿®æ”¹å**:
```python
def detect_and_draw_birds(image_path, model, output_path, dir, ui_settings):
```

**ä»£ç æ¸…ç†**:
1. **ai_model.py:87-88** - ç§»é™¤é¢„è§ˆå›è°ƒé€»è¾‘
   ```python
   # V3.1: ä¸å†ä¿å­˜Cropå›¾ç‰‡ï¼ˆç§»é™¤é¢„è§ˆåŠŸèƒ½ï¼‰
   save_crop = False
   ```

2. **ai_model.py:218-219** - ç§»é™¤cropè·¯å¾„è®¾ç½®
   ```python
   # V3.1: ä¸å†ä¿å­˜Cropå›¾ç‰‡
   crop_path = None
   ```

3. **ai_model.py:363** - ç§»é™¤é¢„è§ˆå›è°ƒè°ƒç”¨
   - åˆ é™¤äº†æ•´ä¸ª `if preview_callback and crop_path` ä»£ç å—ï¼ˆçº¦17è¡Œï¼‰

### 2. main.py è°ƒç”¨æ›´æ–°

**æ–‡ä»¶ä½ç½®**: `main.py:195`

**å½“å‰çŠ¶æ€**: âœ… å·²ç»ä½¿ç”¨ç®€åŒ–ç­¾å
```python
result = detect_and_draw_birds(filepath, model, None, self.dir_path, self.ui_settings)
```

### 3. run_batch.py æ‰¹å¤„ç†è„šæœ¬æ›´æ–°

**æ–‡ä»¶ä½ç½®**: `run_batch.py:93-108`

**ä¿®æ”¹å†…å®¹**:
- æ›´æ–°æ‰¹å¤„ç†è„šæœ¬ä»¥ä½¿ç”¨æ–°çš„ç®€åŒ–API
- æ·»åŠ ui_settingså‚æ•°æ„é€ 

**ä¿®æ”¹å**:
```python
# V3.1: ä½¿ç”¨æ–°çš„ç®€åŒ–API
ui_settings = [
    int(settings['confidence_threshold'] * 100),  # è½¬æ¢ä¸º0-100èŒƒå›´
    settings['sharpness_threshold'],
    5.0,  # NIMAé˜ˆå€¼é»˜è®¤å€¼
    False,  # ä¸ä¿å­˜crop
    'log_compression'  # é»˜è®¤å½’ä¸€åŒ–æ–¹æ³•
]
result = detect_and_draw_birds(
    image_path=jpg_path,
    model=model,
    output_path=None,
    dir=str(work_dir),
    ui_settings=ui_settings
)
```

## ğŸ§ª æµ‹è¯•ç»“æœ

### V3.1 è¯„åˆ†é€»è¾‘æµ‹è¯•
**æµ‹è¯•æ–‡ä»¶**: `test_v31_rating.py`

**æµ‹è¯•ç»“æœ**: âœ… 11/11 é€šè¿‡

æµ‹è¯•è¦†ç›–ï¼š
- âœ… é«˜è´¨é‡ç…§ç‰‡ï¼ˆ3æ˜Ÿï¼‰
- âœ… éƒ¨åˆ†è¾¾æ ‡ç…§ç‰‡ï¼ˆ2æ˜Ÿï¼‰
- âœ… æ™®é€šç…§ç‰‡ï¼ˆ1æ˜Ÿï¼‰
- âœ… æŠ€æœ¯è´¨é‡å·®ï¼ˆ0æ˜Ÿï¼‰
- âœ… ä½ç½®ä¿¡åº¦ï¼ˆ-1æ˜Ÿæ‹’ç»ï¼‰
- âœ… è¾¹ç•Œæƒ…å†µéªŒè¯

### è¯­æ³•æ£€æŸ¥
- âœ… main.py - é€šè¿‡
- âœ… ai_model.py - é€šè¿‡
- âœ… run_batch.py - é€šè¿‡

## ğŸ“Š ä»£ç å½±å“ç»Ÿè®¡

### ai_model.py
- **å‡½æ•°ç­¾å**: ä»8ä¸ªå‚æ•°å‡å°‘åˆ°5ä¸ªå‚æ•°ï¼ˆå‡å°‘37.5%ï¼‰
- **ç§»é™¤ä»£ç **: çº¦25è¡Œé¢„è§ˆç›¸å…³ä»£ç 
- **ä¿ç•™åŠŸèƒ½**: æ‰€æœ‰æ ¸å¿ƒAIæ£€æµ‹ã€è¯„åˆ†ã€EXIFå†™å…¥åŠŸèƒ½

### å—å½±å“çš„æ–‡ä»¶
1. âœ… ai_model.py - ç®€åŒ–å‡½æ•°ç­¾åå’Œå®ç°
2. âœ… main.py - å·²ä½¿ç”¨ç®€åŒ–ç­¾åï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
3. âœ… run_batch.py - æ›´æ–°è°ƒç”¨æ–¹å¼

### æœªå—å½±å“çš„æ–‡ä»¶
- config.py
- sharpness.py
- utils.py
- exiftool_manager.py
- iqa_scorer.py

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### ç§»é™¤çš„åŠŸèƒ½
1. **é¢„è§ˆå›è°ƒæœºåˆ¶** (`preview_callback`)
   - ä¸å†æ”¯æŒå®æ—¶é¢„è§ˆæ›´æ–°
   - å‡å°‘å›è°ƒå¼€é”€

2. **ä¸´æ—¶è£å‰ªç›®å½•** (`crop_temp_dir`)
   - ä¸å†ç”Ÿæˆcropå›¾ç‰‡
   - èŠ‚çœç£ç›˜ç©ºé—´å’ŒI/Oæ“ä½œ

3. **ä¸­å¿ƒé˜ˆå€¼å‚æ•°** (`center_threshold`)
   - V3.1ä¸­ä¸å†ä½¿ç”¨å±…ä¸­æ£€æµ‹
   - ç®€åŒ–è¯„åˆ†é€»è¾‘

### ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½
1. âœ… AIé¸Ÿç±»æ£€æµ‹ï¼ˆYOLOæ¨¡å‹ï¼‰
2. âœ… åŸºäºæ©ç çš„é”åº¦è®¡ç®—
3. âœ… NIMAç¾å­¦è¯„åˆ†
4. âœ… BRISQUEæŠ€æœ¯è´¨é‡è¯„åˆ†
5. âœ… V3.1æ˜Ÿçº§è¯„å®šé€»è¾‘
6. âœ… æ‰¹é‡EXIFå†™å…¥
7. âœ… CSVæŠ¥å‘Šç”Ÿæˆ

## ğŸ¨ APIå˜åŒ–æ‘˜è¦

### æ—§API (V3.0)
```python
detect_and_draw_birds(
    image_path,
    model,
    output_path,
    dir,
    ui_settings,
    crop_temp_dir=None,        # âŒ å·²ç§»é™¤
    center_threshold=None,     # âŒ å·²ç§»é™¤
    preview_callback=None      # âŒ å·²ç§»é™¤
)
```

### æ–°API (V3.1)
```python
detect_and_draw_birds(
    image_path,      # å›¾ç‰‡è·¯å¾„
    model,           # YOLOæ¨¡å‹
    output_path,     # è¾“å‡ºè·¯å¾„ï¼ˆå¯é€‰ï¼Œé€šå¸¸ä¸ºNoneï¼‰
    dir,             # å·¥ä½œç›®å½•
    ui_settings      # [ai_confidence, sharpness_threshold, nima_threshold, save_crop, normalization]
)
```

## ğŸ“ å‡çº§æŒ‡å—

### å¦‚æœä½ åœ¨ä½¿ç”¨æ—§çš„APIè°ƒç”¨

**æ­¥éª¤1**: ç§»é™¤ä¸å†ä½¿ç”¨çš„å‚æ•°
```python
# æ—§ä»£ç 
result = detect_and_draw_birds(
    filepath, model, None, work_dir, ui_settings,
    crop_temp_dir=temp_dir,         # âŒ ç§»é™¤
    center_threshold=0.6,           # âŒ ç§»é™¤
    preview_callback=my_callback    # âŒ ç§»é™¤
)

# æ–°ä»£ç 
result = detect_and_draw_birds(
    filepath, model, None, work_dir, ui_settings
)
```

**æ­¥éª¤2**: ç¡®ä¿ui_settingsæ ¼å¼æ­£ç¡®
```python
ui_settings = [
    50,                    # AIç½®ä¿¡åº¦ (50-100)
    8000,                  # é”åº¦é˜ˆå€¼ (6000-9000)
    5.0,                   # NIMAé˜ˆå€¼ (5.0-6.0)
    False,                 # ä¸ä¿å­˜crop
    'log_compression'      # å½’ä¸€åŒ–æ–¹æ³•
]
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹æ€§**: æ­¤æ›´æ–°ä¸å‘åå…¼å®¹å¸¦æœ‰previewå‚æ•°çš„æ—§ä»£ç 
2. **æ‰¹å¤„ç†è„šæœ¬**: run_batch.pyå·²æ›´æ–°ï¼Œå¯ç›´æ¥ä½¿ç”¨
3. **æµ‹è¯•å»ºè®®**: åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰ï¼Œå»ºè®®ç”¨å°æ‰¹é‡ç…§ç‰‡æµ‹è¯•

## ğŸ‰ æ¸…ç†æˆæœ

- âœ… ä»£ç æ›´ç®€æ´ï¼ˆç§»é™¤~25è¡Œé¢„è§ˆä»£ç ï¼‰
- âœ… APIæ›´ç®€å•ï¼ˆ5ä¸ªå‚æ•° vs 8ä¸ªå‚æ•°ï¼‰
- âœ… æ€§èƒ½æ›´å¥½ï¼ˆæ— é¢„è§ˆå›è°ƒå¼€é”€ï¼‰
- âœ… ç»´æŠ¤æ›´å®¹æ˜“ï¼ˆæ›´å°‘çš„ä¾èµ–å…³ç³»ï¼‰
- âœ… åŠŸèƒ½å®Œæ•´ï¼ˆä¿ç•™æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼‰

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [V3.1å‘å¸ƒè¯´æ˜](V3.1_RELEASE_NOTES.md)
- [è¯„åˆ†é€»è¾‘æµ‹è¯•](test_v31_rating.py)
- [é”åº¦å½’ä¸€åŒ–æŒ‡å—](SHARPNESS_NORMALIZATION_INTEGRATION_GUIDE.md)

---

**ç‰ˆæœ¬**: V3.1.0
**ä½œè€…**: SuperPicky Team
**æœ€åæ›´æ–°**: 2025-10-19
