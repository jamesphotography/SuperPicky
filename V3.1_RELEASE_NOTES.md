# SuperPicky V3.1 发布说明

## 🎯 核心改进

### 1. 公平的锐度评分系统
**问题**：V3.0中大鸟被不公平地惩罚（大鸟锐度仅为小鸟的65%）
**解决方案**：采用对数压缩归一化 `log(1+x) * 1000`

- ✅ 大小鸟公平性提升到 **97.1%**（从65%）
- 📊 新锐度范围：4508-10455
- 🎚️ 滑块范围：6000-9000，步长500，默认7000

### 2. 新增NIMA美学评分
- 🎨 添加NIMA美学滑块：5.0-6.0，步长0.1，默认5.0
- 🔍 NIMA作为质量筛选的重要因素
- 📈 与锐度配合使用，全面评估照片质量

### 3. 简化界面
- ❌ 移除鸟面积滑块（不再作为评分依据）
- 🎯 AI置信度仅用于过滤误识别（<50%拒绝）
- 🎛️ 锐度归一化默认为"对数压缩(V3.1) - 大小鸟公平"

### 4. 全新评分逻辑

#### V3.1 星级评定规则：
```
1. 置信度 < 50% → -1星（Rejected，排除旗标）
2. BRISQUE > 30 或 NIMA < 4.0 或 锐度 < 4000 → 0星（技术质量差）
3. 锐度 ≥ 阈值 且 NIMA ≥ 阈值 → 3星 + 精选旗标（优选）
4. 锐度 ≥ 阈值 或 NIMA ≥ 阈值 → 2星（良好）
5. 其他 → 1星（普通）
```

#### BRISQUE使用策略：
- 作为质量底线：BRISQUE > 30 → 直接0星
- 基于数据分析：
  - 18.4% 优秀照片（<5分）
  - 6.8% 质量差（>30分）

## 📊 技术细节

### 锐度归一化对比
| 方法 | 小鸟平均 | 大鸟平均 | 公平性比例 |
|------|----------|----------|------------|
| V3.0 (sqrt) | 10057 | 6493 | 0.65 ❌ |
| **V3.1 (log)** | **8767** | **8511** | **0.97 ✅** |

### CSV字段变更
**移除字段**：
- "面积达标"
- "居中"
- "锐度达标"

**新增字段**：
- "评分" (数值型：-1/0/1/2/3)

**保留字段**：
- 所有现有字段（文件名、是否有鸟、置信度、坐标、锐度、NIMA、BRISQUE等）

## 🧪 测试结果

### 评分逻辑测试
✅ **11/11** 测试用例通过

测试覆盖：
- 高质量照片（3星）
- 部分达标照片（2星）
- 普通照片（1星）
- 技术质量差（0星）
- 低置信度（-1星拒绝）
- 边界情况验证

## 📝 使用建议

### 推荐设置
- **锐度阈值**：7000（默认）
  - 保守：7500（只选最优）
  - 宽松：6500（多选一些）

- **NIMA阈值**：5.0（默认）
  - 保守：5.3（美学标准更高）
  - 宽松：4.8（接受更多照片）

- **AI置信度**：50%（默认）
  - 仅用于过滤误识别，建议保持默认

### 在Lightroom中使用
1. 导入照片后，SuperPicky自动写入以下EXIF：
   - **Rating**：-1/0/1/2/3星
   - **XMP:Pick**：-1（排除）/0（无）/1（精选）
   - **IPTC:City**：锐度值（用于排序）
   - **IPTC:Country**：NIMA美学评分
   - **IPTC:Province-State**：BRISQUE技术评分

2. 筛选照片：
   - 按星级筛选：显示≥3星的照片
   - 按旗标筛选：显示精选照片
   - 按锐度排序：使用"城市"字段

## ⚠️ 重要提示

### 兼容性
- ✅ 与V3.0 CSV格式向下兼容
- ⚠️ 旧版本无法读取新增的"评分"字段
- 📊 EXIF写入格式保持兼容

### 数据迁移
- 无需迁移现有数据
- 重新运行SuperPicky会生成新格式的report.csv

## 🔧 开发者信息

### 主要文件变更
1. **sharpness.py**
   - 添加 `log_compression` 归一化方法
   - 更新默认归一化为 `log_compression`

2. **main.py**
   - 更新UI：锐度滑块6000-9000，步长500
   - 添加NIMA美学滑块
   - 移除鸟面积滑块
   - 更新评分逻辑

3. **ai_model.py**
   - 简化参数：移除area_threshold、center_threshold
   - 实现新的星级评定规则
   - 更新CSV数据结构

4. **新增文件**
   - `test_v31_rating.py`：评分逻辑测试脚本

## 📅 版本历史

- **V3.1.0** (2025-10-19)
  - 对数压缩锐度归一化
  - 新增NIMA美学评分
  - 全新评分逻辑
  - 简化UI

- **V3.0.1** (2025-10-17)
  - NIMA和BRISQUE集成
  - 批量EXIF写入优化

- **V3.0** (2025-10-15)
  - 基于掩码的锐度计算
  - 实时预览功能

---

**致谢**：感谢用户反馈和测试，帮助SuperPicky不断改进！
