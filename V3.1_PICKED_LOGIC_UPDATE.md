# SuperPicky V3.1 - 精选旗标逻辑更新

## 📋 更新概述

本次更新实现了全新的精选旗标（Picked）逻辑，不再自动给所有3星照片设置精选旗标，而是基于美学和锐度双重排名的交集来精选最优质的照片。

## 🎯 核心功能

### 新的Picked逻辑

1. **收集3星照片**: 处理过程中收集所有评为3星的照片及其美学、锐度数据
2. **双重排名**:
   - 按摄影美学（NIMA）评分排序，取Top N%
   - 按锐度（Sharpness）评分排序，取Top N%
3. **交集计算**: 只有同时出现在两个Top榜单中的照片才被设为精选（Picked=1）
4. **可配置百分比**: 用户可在高级设置中调整Top百分比（5%-20%，默认10%）

### 优点

- **更严格的筛选**: 不是所有3星都被精选，只有美学+锐度双重优秀的才被精选
- **可调节性**: 用户可根据需求调整精选比例
- **质量保证**: 确保精选照片在美学和技术质量上都达到顶级水平

## 📝 修改文件清单

### 1. `advanced_config.py` - 配置管理

**新增配置项**:
```python
"picked_top_percentage": 10,  # 精选旗标Top百分比 (5-20)
```

**新增方法**:
- `picked_top_percentage` (property getter)
- `set_picked_top_percentage(value)` (setter, 范围限制5-20)

### 2. `advanced_settings_dialog.py` - 设置界面

**输出设置选项卡新增**:
- 精选旗标Top百分比滑块（5%-20%，步长5%，默认10%）
- 实时显示当前百分比值
- 说明文字："3星照片中，美学+锐度双排名都在此百分比内的设为精选"

**加载/保存逻辑**:
- `_load_current_config()`: 加载picked_top_percentage
- `_save_settings()`: 保存picked_top_percentage

### 3. `main.py` - 核心处理逻辑

#### 修改1: 初始化3星照片收集列表（第97-98行）
```python
# V3.1: 收集所有3星照片，用于后续计算精选旗标（美学+锐度双排名交集）
star_3_photos = []  # [(raw_file_path, nima_score, sharpness), ...]
```

#### 修改2: 3星照片不再自动设置Picked=1（第261-265行）
```python
# V3.1: 3星照片暂时不设置pick，等全部处理完成后，根据美学+锐度双排名交集设置
if rating_value == 3:
    rating, pick = 3, 0  # 改为pick=0
    self.stats['star_3'] += 1
    self.log_callback(f"  ⭐⭐⭐ 优选照片 (AI:{confidence:.2f}, 锐度:{sharpness:.1f}{iqa_text})", "success")
```

#### 修改3: 收集3星照片信息（第299-305行）
```python
# V3.1: 收集3星照片信息（用于后续计算精选旗标）
if rating_value == 3 and nima is not None:
    star_3_photos.append({
        'file': raw_file_path,
        'nima': nima,
        'sharpness': sharpness
    })
```

#### 修改4: 计算精选旗标交集（第324-364行）
```python
# V3.1: 计算精选旗标（3星照片中美学+锐度双排名交集）
if len(star_3_photos) > 0:
    self.log_callback(f"\n🎯 计算精选旗标 (共{len(star_3_photos)}张3星照片)...")
    config = get_advanced_config()
    top_percent = config.picked_top_percentage / 100.0

    # 计算需要选取的数量（至少1张）
    top_count = max(1, int(len(star_3_photos) * top_percent))

    # 按美学排序，取Top N%
    sorted_by_nima = sorted(star_3_photos, key=lambda x: x['nima'], reverse=True)
    nima_top_files = set([photo['file'] for photo in sorted_by_nima[:top_count]])

    # 按锐度排序，取Top N%
    sorted_by_sharpness = sorted(star_3_photos, key=lambda x: x['sharpness'], reverse=True)
    sharpness_top_files = set([photo['file'] for photo in sorted_by_sharpness[:top_count]])

    # 计算交集（同时在美学和锐度Top N%中的照片）
    picked_files = nima_top_files & sharpness_top_files

    if len(picked_files) > 0:
        self.log_callback(f"  📌 美学Top{config.picked_top_percentage}%: {len(nima_top_files)}张")
        self.log_callback(f"  📌 锐度Top{config.picked_top_percentage}%: {len(sharpness_top_files)}张")
        self.log_callback(f"  ⭐ 双排名交集: {len(picked_files)}张 → 设为精选")

        # 批量写入Pick=1到这些照片（复用现有的exiftool_mgr）
        picked_batch = []
        for file_path in picked_files:
            picked_batch.append({
                'file': file_path,
                'pick': 1
            })

        picked_stats = exiftool_mgr.batch_set_metadata(picked_batch)

        if picked_stats['failed'] > 0:
            self.log_callback(f"  ⚠️  {picked_stats['failed']} 张照片精选旗标写入失败")
        else:
            self.log_callback(f"  ✅ 精选旗标写入成功")
    else:
        self.log_callback(f"  ℹ️  双排名交集为空，未设置精选旗标")
```

## 🔍 工作流程示例

假设有10张3星照片，设置Top百分比为10%：

1. **收集数据**:
   ```
   照片A: 美学5.8, 锐度8500
   照片B: 美学6.2, 锐度9200  ← 美学排名#1
   照片C: 美学5.5, 锐度9800  ← 锐度排名#1
   照片D: 美学5.9, 锐度8800
   ... (其余6张)
   ```

2. **计算Top 10%** (至少1张):
   - Top数量 = max(1, 10 × 10%) = 1张

3. **美学Top 1张**:
   - 照片B (美学6.2)

4. **锐度Top 1张**:
   - 照片C (锐度9800)

5. **交集计算**:
   - {照片B} ∩ {照片C} = {} (空集)
   - 结果：双排名交集为空，未设置精选旗标

**调整为Top 20%后**:
   - Top数量 = max(1, 10 × 20%) = 2张
   - 美学Top 2张: {照片B, 照片D}
   - 锐度Top 2张: {照片C, 照片D}
   - 交集: {照片D} → 照片D被设为精选

## 📊 配置文件格式

`advanced_config.json` 新增字段:
```json
{
  "min_confidence": 0.5,
  "min_sharpness": 4000,
  "min_nima": 4.0,
  "max_brisque": 30,
  "picked_top_percentage": 10,
  "save_csv": true,
  "log_level": "detailed",
  "language": "zh_CN"
}
```

## 🎯 用户使用指南

### 调整精选百分比

1. 打开SuperPicky
2. 点击菜单栏 **设置** → **高级设置...**
3. 切换到 **输出设置** 选项卡
4. 拖动 **精选旗标Top百分比** 滑块（5% / 10% / 15% / 20%）
5. 点击 **保存**

### 查看处理结果

处理完成后，日志会显示：
```
🎯 计算精选旗标 (共25张3星照片)...
  📌 美学Top10%: 3张
  📌 锐度Top10%: 3张
  ⭐ 双排名交集: 2张 → 设为精选
  ✅ 精选旗标写入成功
```

### 在Lightroom中查看

1. 导入照片或重新读取元数据
2. 筛选条件：
   - **星级 = 3星**: 所有优质照片
   - **旗标 = 精选**: 美学+锐度双优的顶级照片
3. 推荐工作流程：
   - 先查看精选照片（3星+精选旗标）→ 最优质的照片
   - 再查看其他3星照片 → 高质量但未达到顶级
   - 按需查看2星、1星照片

## ⚠️ 注意事项

1. **至少1张精选**: 即使百分比计算结果<1，也会至少选择1张（如果有3星照片）
2. **需要美学评分**: 只有有NIMA评分的3星照片才会被纳入计算
3. **交集可能为空**: 如果美学Top和锐度Top完全不重叠，则不会有照片被设为精选
4. **建议百分比**:
   - 5%: 极度严格，适合大量照片（>200张3星）
   - 10%: 推荐设置，平衡质量和数量
   - 15-20%: 较宽松，适合少量照片（<50张3星）

## 🧪 测试建议

1. 准备测试数据集（至少20张照片，能产生5-10张3星）
2. 分别测试5%, 10%, 15%, 20%的精选百分比
3. 验证：
   - 日志输出正确显示双排名数量和交集
   - EXIF Pick标记正确写入
   - Lightroom能正确识别精选旗标
4. 边界测试：
   - 只有1张3星照片
   - 所有3星照片美学/锐度评分完全一致
   - 没有3星照片

---

**版本**: V3.1.1
**日期**: 2025-10-19
**作者**: SuperPicky Team
