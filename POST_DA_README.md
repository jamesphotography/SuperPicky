# 二次选鸟功能 (Post Digital Adjustment) 说明文档

## 📋 功能概述

**二次选鸟**是 SuperPicky V3.1.4+ 的增强功能，允许用户基于已有的AI分析结果，快速调整评分标准并重新计算星级评分，**无需重新运行耗时的AI推理**。

---

## 🎯 核心优势

### ⚡ **速度提升**
- **原方式**（重新运行AI）: 5-20分钟
- **二次选鸟**: **5-10秒**（仅CSV读取 + EXIF写入）

### 🔄 **实时预览**
- 拖动滑块立即看到新星级分布
- 对比显示变化（+/-多少张，百分比）
- 无需等待，即时反馈

### 💾 **数据复用**
- 基于已生成的 `_tmp/report.csv` 数据
- 所有AI分析结果（置信度、锐度、美学、失真）已保存
- 无需重新进行图像质量评估

---

## 🚀 使用方法

### 1️⃣ **触发条件**

在以下情况下，主界面会显示"📊 二次选鸟"按钮：

- ✅ 已完成一次"开始处理"（存在 `_tmp/report.csv`）
- ✅ 或者，浏览目录时检测到历史分析数据

### 2️⃣ **操作步骤**

```
1. 点击"📊 二次选鸟"按钮
2. 查看当前星级分布
3. 拖动滑块调整阈值：
   - 锐度阈值 (2/3星): 6000-9000
   - 美学阈值 (2/3星): 4.5-5.5
   - 精选旗标百分比: 10%-50%
4. 实时查看预览效果
5. 点击"✅ 应用新评分"
6. 确认后，EXIF元数据立即更新
```

### 3️⃣ **使用场景示例**

**场景1：3星照片太少**
```
当前: 3星只有20张，感觉太严格
操作: 降低锐度阈值 8000 → 7500
结果: 3星增加到35张 (+15张，预览立即显示)
```

**场景2：想要更多精选照片**
```
当前: 精选旗标只有5张
操作: 提高精选百分比 25% → 35%
结果: 精选增加到12张 (+7张)
```

**场景3：不同摄影主题调整**
```
风光摄影: 更看重锐度，可提高锐度权重
人像摄影: 更看重美学，可降低锐度要求
鸟类摄影: 均衡调整，找到最佳平衡点
```

---

## 🎨 界面布局

```
┌─────────────────────────────────────────┐
│  二次选鸟 - 重新调整评分标准              │
├─────────────────────────────────────────┤
│ 📊 当前星级分布                          │
│ ⭐⭐⭐ 3星: 50张 (10.0%)               │
│ ⭐⭐ 2星: 80张 (16.0%)                 │
│ ⭐ 1星: 200张 (40.0%)                  │
│ 0星: 120张 (24.0%)                     │
├─────────────────────────────────────────┤
│ ⚙️  调整评分阈值                         │
│ 拖动滑块调整阈值，实时预览新的星级分布     │
│                                         │
│ 锐度阈值 (2/3星):                       │
│ [6000────●────7500────────9000]  7500  │
│                                         │
│ 美学阈值 (2/3星):                       │
│ [4.5─────●────4.8──────5.5]  4.8       │
│                                         │
│ 精选旗标百分比:                          │
│ [10%─────●────25%──────50%]  25%       │
├─────────────────────────────────────────┤
│ 📈 调整后预览                            │
│ ⭐⭐⭐ 3星: 50 → 65张 [+15, +30.0%]   │
│ ⭐⭐ 2星: 80 → 70张 [-10, -12.5%]     │
│ ⭐ 1星: 200 → 185张 [-15, -7.5%]      │
│ 🏆 精选: 12 → 16张 [+4, +33.3%]       │
├─────────────────────────────────────────┤
│                  [取消]  [✅ 应用新评分]  │
└─────────────────────────────────────────┘
```

---

## 🔧 技术实现

### 核心组件

1. **PostAdjustmentEngine** (`post_adjustment_engine.py`)
   - 读取 `_tmp/report.csv`
   - 重新计算星级（基于CSV数据）
   - 计算精选旗标（3星照片双Top%交集）
   - 统计各星级数量

2. **PostAdjustmentDialog** (`post_adjustment_dialog.py`)
   - UI对话框
   - 实时预览（防抖处理）
   - 批量EXIF写入
   - 进度显示和错误处理

3. **主界面集成** (`main.py`)
   - 自动检测 `report.csv` 存在性
   - 动态启用/禁用"二次选鸟"按钮
   - 完成回调处理

### 星级评定逻辑

与 `ai_model.py:347-378` 完全一致：

```python
# 0星判定（技术质量差）
if 置信度 < 0.5 OR 失真 > 30 OR 美学 < 4.0 OR 锐度 < 4000:
    → 0星

# 3星判定（优选：锐度和美学双达标）
elif 锐度 >= 7500 AND 美学 >= 4.8:
    → 3星

# 2星判定（良好：锐度或美学达标其一）
elif 锐度 >= 7500 OR 美学 >= 4.8:
    → 2星

# 1星（普通）
else:
    → 1星
```

### 精选旗标逻辑

与 `main.py:355-399` 完全一致：

```python
1. 筛选所有3星照片
2. 按美学排序，取Top 25%
3. 按锐度排序，取Top 25%
4. 计算交集 → 设为精选旗标
```

---

## 📊 数据结构

### CSV 字段映射

```csv
文件名, 是否有鸟, 置信度, X坐标, Y坐标, 鸟占比, 像素数,
原始锐度, 归一化锐度, NIMA美学, BRISQUE技术, 星等, 评分,
面积达标, 居中, 锐度达标, 类别ID
```

**关键字段**：
- `置信度`: AI检测置信度 (0.00-1.00)
- `归一化锐度`: 对数压缩后的锐度值 (0-15000+)
- `NIMA美学`: 美学评分 (0.00-10.00)
- `BRISQUE技术`: 技术失真评分 (0.00-100.00)
- `评分`: 原始星级 (-1/0/1/2/3)

---

## ⚠️ 注意事项

### 1. **文件存在性**
- 二次选鸟会查找实际图片文件
- 如果照片被删除/移动，会跳过并统计

### 2. **4-5星保护**
- 目前版本：暂未实现4-5星保护
- 计划：读取当前Rating，跳过用户手动标记的4-5星照片

### 3. **数据一致性**
- CSV可能与当前目录不同步
- 重置目录后，CSV会被删除

### 4. **只更新 Rating 和 Pick**
- 不更新 City/Province/Country（锐度/美学/失真）
- 这些值没有变化，无需重写

---

## 🧪 测试

### 单元测试
```bash
python3 test_post_da.py
```

### 功能测试场景

**测试1：基本流程**
1. 运行"开始处理"完成分析
2. 点击"二次选鸟"
3. 调整阈值
4. 应用新评分
5. 在Lightroom中验证星级更新

**测试2：边界情况**
- 0张3星照片 → 精选旗标为0
- 全是3星照片 → 按百分比计算精选
- 部分照片无美学评分（"-"）→ 正常处理

**测试3：性能测试**
- 1000+照片 → 预览响应时间 < 1秒
- 批量EXIF写入 → 完成时间 < 10秒

---

## 📝 后续优化计划

### 高优先级
- [ ] 实现4-5星保护（读取当前Rating）
- [ ] 添加"重置到原始评分"按钮
- [ ] 显示文件未找到的详细列表

### 中优先级
- [ ] 支持单张照片预览（点击查看详细数据）
- [ ] 保存调整历史记录（最近3次）
- [ ] 导出调整报告（对比前后）

### 低优先级
- [ ] 支持更多阈值调整（0星判定阈值）
- [ ] 批量导出精选照片
- [ ] 与Lightroom插件联动

---

## 🎉 总结

**二次选鸟**功能是对 SuperPicky 工作流程的重要增强，让用户能够：

- ⚡ **快速迭代**：几秒钟内尝试不同评分标准
- 🎯 **精准控制**：找到最适合自己的评分阈值
- 💰 **节省时间**：避免重复运行耗时的AI分析
- 📊 **数据驱动**：基于实际分析结果优化筛选策略

---

**慧眼选鸟 - 让AI帮你挑选最美的瞬间 🦅📸**
